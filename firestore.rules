rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user owns the business
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Helper function to check if user has active subscription
    function hasActiveSubscription(userId) {
      let subscriptionPath = /databases/$(database)/documents/subscriptions/$(userId);
      // If subscription doesn't exist yet, allow access (for initial setup)
      return !exists(subscriptionPath) ? true :
             get(subscriptionPath).data.status == 'active' &&
             get(subscriptionPath).data.accessBlocked == false;
    }

    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    // Helper function to check access (admin OR active subscription)
    function hasAccess(userId) {
      return isAdmin() || hasActiveSubscription(userId);
    }

    // Subscriptions collection
    match /subscriptions/{userId} {
      // Users can read their own subscription, admins can read all
      allow read: if isAuthenticated() && (isOwner(userId) || isAdmin());
      // Resellers pueden leer suscripciones de clientes que crearon
      allow read: if isAuthenticated() && resource.data.resellerId == request.auth.uid;
      // Resellers pueden leer por query de sus clientes (email match)
      allow read: if isAuthenticated() &&
        exists(/databases/$(database)/documents/resellers/$(request.auth.uid)) ||
        get(/databases/$(database)/documents/resellers/$(request.auth.uid)).data.email == request.auth.token.email;
      // Users can create their own subscription (for trial), admins can modify any
      allow create: if isAuthenticated() && isOwner(userId);
      // Resellers pueden crear suscripciones para sus clientes
      allow create: if isAuthenticated() && request.resource.data.resellerId == request.auth.uid;
      // Only admins can update/delete subscriptions
      allow update, delete: if isAdmin();
      // Resellers pueden actualizar suscripciones de sus clientes
      allow update: if isAuthenticated() && resource.data.resellerId == request.auth.uid;
    }

    // Admins collection (lista de UIDs de administradores)
    match /admins/{userId} {
      allow read: if isAuthenticated();
      allow write: if false; // Solo se gestiona manualmente desde consola Firebase
    }

    // Config collection (configuración del sistema)
    match /config/{configId} {
      // Solo admins pueden leer/escribir configuración del sistema
      allow read, write: if isAdmin();
    }

    // Resellers collection
    match /resellers/{resellerId} {
      // Resellers pueden leer/escribir sus propios datos (por UID)
      allow read, write: if isAuthenticated() && isOwner(resellerId);
      // Usuarios autenticados pueden buscar si son resellers (por email)
      allow read: if isAuthenticated() && resource.data.email == request.auth.token.email;
      // Admins pueden leer/escribir cualquier reseller
      allow read, write: if isAdmin();
    }

    // Reseller Transactions collection
    match /resellerTransactions/{transactionId} {
      // Resellers pueden leer sus transacciones
      allow read: if isAuthenticated() && resource.data.resellerId == request.auth.uid;
      // Resellers pueden crear transacciones (solo sus propias)
      allow create: if isAuthenticated() && request.resource.data.resellerId == request.auth.uid;
      // Admins pueden leer/escribir cualquier transacción
      allow read, write: if isAdmin();
    }

    // Users collection (para gestión de usuarios y permisos)
    match /users/{userId} {
      // Cualquier usuario autenticado puede leer su propio documento
      allow get: if isAuthenticated() && isOwner(userId);

      // Business Owners pueden leer usuarios que ellos crearon mediante query
      // IMPORTANTE: La query debe filtrar por ownerId igual al uid del usuario autenticado
      allow list: if isAuthenticated();

      // Admins pueden leer cualquier usuario
      allow read: if isAdmin();

      // Permitir crear documentos en dos casos:
      // 1. Usuario creando su propio documento de Business Owner (userId == auth.uid)
      // 2. Business Owner creando sub-usuario (ownerId == auth.uid)
      allow create: if isAuthenticated() && (
        isOwner(userId) ||
        request.resource.data.ownerId == request.auth.uid
      );

      // Los usuarios pueden actualizar su propio documento
      allow update: if isAuthenticated() && isOwner(userId);

      // Business Owners pueden actualizar usuarios que crearon
      allow update: if isAuthenticated() &&
                       resource.data.ownerId == request.auth.uid;

      // Admins pueden hacer cualquier cosa
      allow write: if isAdmin();

      // Business Owners pueden eliminar usuarios que crearon
      allow delete: if isAuthenticated() &&
                       resource.data.ownerId == request.auth.uid;

      // Subcollection: FCM Tokens (para notificaciones push)
      match /fcmTokens/{tokenId} {
        // Los usuarios pueden leer, escribir y eliminar sus propios tokens FCM
        allow read, write: if isAuthenticated() && isOwner(userId);
      }
    }

    // Notifications collection
    match /notifications/{notificationId} {
      // Users can only read/write their own notifications
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // Helper function to check if user is sub-user of business owner
    function isSubUserOf(ownerId) {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return userDoc.data.ownerId == ownerId && userDoc.data.isActive == true;
    }

    // Helper function to check if user can access business data
    // Returns true if: user is owner OR user is active sub-user of owner
    function canAccessBusiness(userId) {
      return isOwner(userId) || isSubUserOf(userId);
    }

    // Businesses (Negocios)
    // Cada usuario tiene un solo negocio con su userId como ID
    // IMPORTANTE: Los administradores tienen acceso sin importar su suscripción
    // Sub-usuarios (employees) pueden acceder a los datos del Business Owner
    match /businesses/{userId} {
      // Admins pueden leer/escribir cualquier negocio
      allow read, write: if isAdmin();
      // Owners y sub-usuarios pueden acceder a su propio negocio si tienen acceso activo
      allow read: if isAuthenticated() && canAccessBusiness(userId) && hasAccess(userId);
      allow write: if isAuthenticated() && canAccessBusiness(userId) && hasAccess(userId);

      // Subcollection: Invoices (Facturas/Boletas)
      match /invoices/{invoiceId} {
        // Admins pueden leer todas las facturas
        allow read: if isAdmin() || (isAuthenticated() && canAccessBusiness(userId) && hasAccess(userId));
        allow write: if isAuthenticated() && canAccessBusiness(userId) && hasAccess(userId);
      }

      // Subcollection: Customers (Clientes)
      match /customers/{customerId} {
        // Admins pueden leer todos los clientes
        allow read: if isAdmin() || (isAuthenticated() && canAccessBusiness(userId) && hasAccess(userId));
        allow write: if isAuthenticated() && canAccessBusiness(userId) && hasAccess(userId);
      }

      // Subcollection: Products (Productos)
      match /products/{productId} {
        // Admins pueden leer todos los productos
        allow read: if isAdmin() || (isAuthenticated() && canAccessBusiness(userId) && hasAccess(userId));
        allow write: if isAuthenticated() && canAccessBusiness(userId) && hasAccess(userId);
      }

      // Subcollection: Cash Register Sessions (Sesiones de Caja)
      match /cashSessions/{sessionId} {
        allow read: if isAuthenticated() && canAccessBusiness(userId) && hasAccess(userId);
        allow write: if isAuthenticated() && canAccessBusiness(userId) && hasAccess(userId);
      }

      // Subcollection: Cash Movements (Movimientos de Caja)
      match /cashMovements/{movementId} {
        allow read: if isAuthenticated() && canAccessBusiness(userId) && hasAccess(userId);
        allow write: if isAuthenticated() && canAccessBusiness(userId) && hasAccess(userId);
      }

      // Subcollection: Suppliers (Proveedores)
      match /suppliers/{supplierId} {
        allow read: if isAuthenticated() && canAccessBusiness(userId) && hasAccess(userId);
        allow write: if isAuthenticated() && canAccessBusiness(userId) && hasAccess(userId);
      }

      // Subcollection: Purchases (Compras)
      match /purchases/{purchaseId} {
        allow read: if isAuthenticated() && canAccessBusiness(userId) && hasAccess(userId);
        allow write: if isAuthenticated() && canAccessBusiness(userId) && hasAccess(userId);
      }

      // Subcollection: Quotations (Cotizaciones)
      match /quotations/{quotationId} {
        allow read: if isAuthenticated() && canAccessBusiness(userId) && hasAccess(userId);
        allow write: if isAuthenticated() && canAccessBusiness(userId) && hasAccess(userId);
      }

      // Subcollection: Warehouses (Almacenes)
      match /warehouses/{warehouseId} {
        allow read: if isAuthenticated() && canAccessBusiness(userId) && hasAccess(userId);
        allow write: if isAuthenticated() && canAccessBusiness(userId) && hasAccess(userId);
      }

      // Subcollection: Stock Movements (Movimientos de Inventario)
      match /stockMovements/{movementId} {
        allow read: if isAuthenticated() && canAccessBusiness(userId) && hasAccess(userId);
        allow write: if isAuthenticated() && canAccessBusiness(userId) && hasAccess(userId);
      }

      // Subcollection: Tables (Mesas - para modo restaurante)
      match /tables/{tableId} {
        allow read: if isAuthenticated() && canAccessBusiness(userId) && hasAccess(userId);
        allow write: if isAuthenticated() && canAccessBusiness(userId) && hasAccess(userId);
      }

      // Subcollection: Waiters (Mozos - para modo restaurante)
      match /waiters/{waiterId} {
        allow read: if isAuthenticated() && canAccessBusiness(userId) && hasAccess(userId);
        allow write: if isAuthenticated() && canAccessBusiness(userId) && hasAccess(userId);
      }

      // Subcollection: Sellers (Vendedores)
      match /sellers/{sellerId} {
        allow read: if isAuthenticated() && canAccessBusiness(userId) && hasAccess(userId);
        allow write: if isAuthenticated() && canAccessBusiness(userId) && hasAccess(userId);
      }

      // Subcollection: Orders (Órdenes - para modo restaurante)
      match /orders/{orderId} {
        allow read: if isAuthenticated() && canAccessBusiness(userId) && hasAccess(userId);
        allow write: if isAuthenticated() && canAccessBusiness(userId) && hasAccess(userId);
      }

      // Subcollection: Counters (Contadores - para números secuenciales)
      match /counters/{counterId} {
        allow read: if isAuthenticated() && canAccessBusiness(userId) && hasAccess(userId);
        allow write: if isAuthenticated() && canAccessBusiness(userId) && hasAccess(userId);
      }

      // Subcollection: Emission Config (Configuración de emisión electrónica)
      match /emissionConfig/{configId} {
        // Owners y sub-usuarios pueden leer configuración para calcular IGV
        allow read: if isAuthenticated() && canAccessBusiness(userId) && hasAccess(userId);
        // Solo admins pueden escribir (se configura desde panel admin)
        allow write: if isAdmin();
      }

      // Subcollection: Ingredients (Ingredientes - para modo restaurante)
      match /ingredients/{ingredientId} {
        allow read: if isAuthenticated() && canAccessBusiness(userId) && hasAccess(userId);
        allow write: if isAuthenticated() && canAccessBusiness(userId) && hasAccess(userId);
      }

      // Subcollection: Recipes (Recetas - para modo restaurante)
      match /recipes/{recipeId} {
        allow read: if isAuthenticated() && canAccessBusiness(userId) && hasAccess(userId);
        allow write: if isAuthenticated() && canAccessBusiness(userId) && hasAccess(userId);
      }

      // Subcollection: Ingredient Purchases (Compras de Ingredientes - para modo restaurante)
      match /ingredientPurchases/{purchaseId} {
        allow read: if isAuthenticated() && canAccessBusiness(userId) && hasAccess(userId);
        allow write: if isAuthenticated() && canAccessBusiness(userId) && hasAccess(userId);
      }

      // Subcollection: Stock Movements for Ingredients (Movimientos de Stock de Ingredientes)
      match /stockMovements/{movementId} {
        allow read: if isAuthenticated() && canAccessBusiness(userId) && hasAccess(userId);
        allow write: if isAuthenticated() && canAccessBusiness(userId) && hasAccess(userId);
      }
    }
  }
}
